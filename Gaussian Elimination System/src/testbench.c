#include <signal.h>
#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <pthread.h>
#include <pthreadUtils.h>
#include <Pipes.h>
#include <pipeHandler.h>
#ifndef SW
#include "SockPipes.h"
#include "vhdlCStubs.h"
#else
#include "aa_c_model.h"
#endif

#define N 16
#define N1 17
#define N2 272

float matrix[N][N1] = {{57.67,36.18,0.81,26.4,0.25,25.24,0.11,-6.35,2.63,11.28,18.39,-28.59,-35.6,7.34,-23.82,-8.44,-0.77}
,{36.18,48.49,3.16,22.97,11.06,8.35,3.78,-1.54,-15.94,7.72,17.28,-13.1,-35.74,15.39,-24.42,-3.64,0.64}
,{0.81,3.16,29.05,8.67,-16.06,10.2,1.71,3.53,-9.68,-17.19,-3.53,-4.56,2.06,0.26,-0.15,-15.81,0.77}
,{26.4,22.97,8.67,60.76,-33.9,31.95,-8.12,-14.23,-8.6,24.17,0.27,-0.54,-34.46,3.69,-21.77,-21.54,3.13}
,{0.25,11.06,-16.06,-33.9,61.69,-14.27,9.85,7.15,-1.85,-5.28,6.62,12.45,1.11,1.16,11.32,23.78,2.27}
,{25.24,8.35,10.2,31.95,-14.27,65.4,-8.55,5.87,21.51,15.41,-13.72,-12.22,-15.03,-9.3,-17.15,-7.76,0.16}
,{0.11,3.78,1.71,-8.12,9.85,-8.55,20.66,-5.57,8.67,-14.22,13.62,-13.04,-1.72,12.1,-0.16,3.26,0.0}
,{-6.35,-1.54,3.53,-14.23,7.15,5.87,-5.57,39.62,-4.78,-1.35,-15.03,4.65,9.28,-0.04,0.9,1.56,2.4}
,{2.63,-15.94,-9.68,-8.6,-1.85,21.51,8.67,-4.78,66.64,-9.13,7.17,-14.37,1.48,-16.73,-1.09,-1.25,1.98}
,{11.28,7.72,-17.19,24.17,-5.28,15.41,-14.22,-1.35,-9.13,60.25,-1.17,15.91,-12.44,1.48,-23.1,10.77,-1.93}
,{18.39,17.28,-3.53,0.27,6.62,-13.72,13.62,-15.03,7.17,-1.17,42.48,-11.14,-17.99,8.24,-19.55,2.01,1.48}
,{-28.59,-13.1,-4.56,-0.54,12.45,-12.22,-13.04,4.65,-14.37,15.91,-11.14,55.07,7.95,-10.9,17.97,-3.95,1.43}
,{-35.6,-35.74,2.06,-34.46,1.11,-15.03,-1.72,9.28,1.48,-12.44,-17.99,7.95,52.19,8.94,20.07,16.95,0.69}
,{7.34,15.39,0.26,3.69,1.16,-9.3,12.1,-0.04,-16.73,1.48,8.24,-10.9,8.94,75.84,-8.71,7.98,-0.93}
,{-23.82,-24.42,-0.15,-21.77,11.32,-17.15,-0.16,0.9,-1.09,-23.1,-19.55,17.97,20.07,-8.71,40.46,-2.45,1.62}
,{-8.44,-3.64,-15.81,-21.54,23.78,-7.76,3.26,1.56,-1.25,10.77,2.01,-3.95,16.95,7.98,-2.45,39.65,-0.51}};

float outputs[N];
int all_done = 0;

void SendInputs ()
{
	float elements[N2];
	int i, j;

	for(i = 0; i < N; i++)
	{
        for(j = 0; j < N1; j++) 
            elements[N1*i + j] = matrix[i][j];
	}

    write_float32_n("input_data", elements, N2);
}

void ReceiveResults ()
{
    int i;

	read_float32_n("output_data", outputs, N);

	for(i = 0; i < N; i++)
        fprintf(stderr, "X[%d] = %f\n", i, outputs[i]);

    all_done = 1;
    printf("\n");
}

DEFINE_THREAD(SendInputs)
DEFINE_THREAD(ReceiveResults)

void Exit(int sig)
{
	fprintf(stderr, "## Break! ##\n");
	exit(0);
}
	
int main(int argc, char* argv[])
{
	int _err_ = 0;
	signal(SIGINT,  Exit);
  	signal(SIGTERM, Exit);

    #ifdef SW
	start_daemons(stdout, 0);	
    #endif

    PTHREAD_DECL(SendInputs);
    PTHREAD_DECL(ReceiveResults);
	
    PTHREAD_CREATE(SendInputs);
	PTHREAD_CREATE(ReceiveResults);

    ge();

    while(!all_done)
	{
	}

	return(0);
}
